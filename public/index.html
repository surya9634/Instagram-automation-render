<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>IG DM Auto (Prototype)</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 18px; max-width: 900px; margin: auto; }
    .card { border: 1px solid #ddd; padding: 14px; border-radius: 8px; margin-bottom: 12px; }
    button { padding: 8px 12px; cursor: pointer; }
    input, textarea { width: 100%; padding: 8px; margin: 6px 0; box-sizing: border-box; }
    .small { font-size: 0.9rem; color: #666 }
    .post { display:flex; gap:10px; align-items:center; }
    .post img { width:80px; height:80px; object-fit:cover; border-radius:6px; }
    .hotword { background:#f2f2f2; padding:6px 8px; border-radius:6px; display:inline-block; margin:4px; }
    .log { font-size:0.9rem; color: #333; border-top:1px dashed #ddd; padding-top:8px; margin-top:8px }
  </style>
</head>
<body>
  <h2>Instagram DM Automation — Prototype</h2>
  <div class="card">
    <p class="small">Step 1. Connect your Instagram (opens Instagram / Facebook OAuth). Make sure you use a Professional Instagram (Business/Creator) and that the Page is linked.</p>
    <button id="connectBtn">Connect Instagram</button>
  </div>

  <div class="card" id="postsCard" style="display:none;">
    <h3>Your Posts</h3>
    <div id="postsList">Loading...</div>
  </div>

  <div class="card" id="configCard" style="display:none;">
    <h3>Add Hotword & Reply</h3>
    <div>
      <label>Post ID</label>
      <input id="postIdInput" placeholder="Paste post id (from posts list)"/>
      <label>Hotword</label>
      <input id="hotwordInput" placeholder="e.g., hello"/>
      <label>Reply message</label>
      <textarea id="replyInput" rows="3" placeholder="Reply text that will be sent as DM"></textarea>
      <button id="saveConfigBtn">Save Hotword</button>
    </div>
  </div>

  <div class="card" id="logsCard" style="display:none;">
    <h3>Logs</h3>
    <div id="logsList">No logs yet.</div>
  </div>

<script>
document.getElementById('connectBtn').addEventListener('click', () => {
  window.location.href = '/auth/instagram';
});

async function refreshPosts() {
  try {
    const r = await fetch('/api/posts');
    if (r.status === 401) {
      // not connected
      document.getElementById('postsCard').style.display = 'none';
      document.getElementById('configCard').style.display = 'none';
      document.getElementById('logsCard').style.display = 'none';
      return;
    }
    const data = await r.json();
    const posts = data.data || [];
    const postsList = document.getElementById('postsList');
    postsList.innerHTML = '';
    posts.forEach(p => {
      const el = document.createElement('div');
      el.className = 'post';
      const thumb = p.thumbnail_url || p.media_url || '';
      el.innerHTML = `
        <div style="flex:0 0 90px"><img src="${thumb}" alt="thumb" /></div>
        <div style="flex:1">
          <div><strong>${p.caption ? p.caption.slice(0,80) : '(no caption)'}</strong></div>
          <div class="small">Post id: <code>${p.id}</code> • ${p.media_type} • ${new Date(p.timestamp).toLocaleString()}</div>
        </div>
      `;
      postsList.appendChild(el);
    });
    document.getElementById('postsCard').style.display = posts.length ? 'block' : 'none';
    document.getElementById('configCard').style.display = 'block';
    document.getElementById('logsCard').style.display = 'block';
  } catch (err) {
    console.error(err);
  }
}

document.getElementById('saveConfigBtn').addEventListener('click', async () => {
  const postId = document.getElementById('postIdInput').value.trim();
  const hotword = document.getElementById('hotwordInput').value.trim();
  const reply = document.getElementById('replyInput').value.trim();
  if (!postId || !hotword || !reply) return alert('postId, hotword and reply required');
  const r = await fetch('/api/config', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ postId, hotword, reply })
  });
  const j = await r.json();
  if (j.ok) {
    alert('Saved');
    document.getElementById('hotwordInput').value = '';
    document.getElementById('replyInput').value = '';
    loadLogs();
  } else {
    alert('Error saving config: ' + (j.error || 'unknown'));
  }
});

async function loadLogs() {
  const r = await fetch('/api/logs');
  if (r.status === 401) return;
  const j = await r.json();
  const logs = j.logs || [];
  const out = document.getElementById('logsList');
  if (!logs.length) { out.innerHTML = 'No logs yet.'; return; }
  out.innerHTML = logs.slice().reverse().map(l => `
    <div class="log">
      <div><strong>${l.commenter_username || l.commenter_id}</strong> commented "${l.comment_text}" on post ${l.postId}</div>
      <div class="small">Replied: ${l.reply_sent} — ${new Date(l.when).toLocaleString()}</div>
    </div>
  `).join('');
}

setInterval(() => {
  refreshPosts();
  loadLogs();
}, 3000);

refreshPosts();
loadLogs();
</script>
</body>
</html>
